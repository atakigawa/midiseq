function configureMatrixApp($locationProvider,$httpProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!0}),$httpProvider.defaults.headers.common["X-Requested-With"]="XMLHttpRequest"}function routeMatrixApp($routeProvider){$routeProvider.when("/",{templateUrl:"/templates/top.index",controller:"IndexController",controllerAs:"vm",title:"midiseq"}).otherwise({redirectTo:"/"})}function IndexController($location,$window,$routeParams,$controller,$log,_,jq,MidiService,SeqGenClientService,PlayerLibModel,MasterData){function init(){var midiMgr=MidiService.getMidiManager();console.log(midiMgr);SeqGenClientService.getClient({url:location.host+"/ws/midi"});vm.player=(new PlayerLibModel).getPlayer({mst:vm.mst,midiManager:midiMgr}),vm.player.PreInit()}function toggleSetupPanelVisible(){vm.isSetupPanelVisible=!vm.isSetupPanelVisible}var vm=this;vm.mst=MasterData,vm.player=null,vm.isSetupPanelVisible=!0,vm.toggleSetupPanelVisible=toggleSetupPanelVisible,init()}function MidiService(){function getMidiManager(){return new MidiManager}return{getMidiManager:getMidiManager}}function MidiManager(){}function SeqGenClientService(params){function getClient(params){return new SocketIOClient(params)}return{getClient:getClient}}function SocketIOClient(params){var socket=io(params.url);socket.on("connect",function(){socket.emit("ping",{msg:"ping msg from browser"})}),socket.on("pong",function(m){console.log("pong has returned"),console.log(m)}),socket.on("disconnect",function(){}),this.socket=socket}function MasterData(_,jq){function addConsts(obj){obj.C={SYNC:{SEND:1,RECV:2,NONE:3},LOOP:{FWD:1,REV:2,PINGPONG:3,INNER_PINGPONG:4}}}function addPlayerMasters(obj){obj.tempoList=_.map(_.range(40,241),function(e){return{value:e,name:e}}),obj.syncList=[{value:obj.C.SYNC.SEND,name:"Send"},{value:obj.C.SYNC.RECV,name:"Receive"},{value:obj.C.SYNC.NONE,name:"Neither"}]}function addSequencerMasters(obj){obj.scaletab=[{name:"Chromatic",notes:[1,1,1,1,1,1,1,1,1,1,1,1]},{name:"Major",notes:[1,0,1,0,1,1,0,1,0,1,0,1]},{name:"Natural Minor",notes:[1,0,1,1,0,1,0,1,1,0,1,0]},{name:"Harmonic Minor",notes:[1,0,1,1,0,1,0,1,1,0,0,1]},{name:"Whole Tone",notes:[1,0,1,0,1,0,1,0,1,0,1,0]},{name:"Diminish",notes:[1,0,1,1,0,1,1,0,1,1,0,1]},{name:"Major Pentatonic",notes:[1,0,1,0,1,0,0,1,0,1,0,0]},{name:"Minor Pentatonic",notes:[1,0,0,1,0,1,0,1,0,0,1,0]},{name:"Blues",notes:[1,0,0,1,0,1,1,1,0,1,1,0]},{name:"Gamelan",notes:[1,1,0,1,0,0,0,1,1,0,0,0]}],obj.ntable=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],obj.scaleList=_.map(obj.scaletab,function(e,i){return{value:i,name:e.name}}),obj.rangeList=_.map(_.range(1,7),function(e){return{value:e,name:e}}),obj.channelList=_.map(_.range(1,17),function(e){return{value:e,name:e}}),obj.triggerList=_.map(_.range(1,25),function(e){return{value:e,name:e}}),obj.transposeList=_.map(_.range(-48,49),function(e){return{value:e,name:e}}),obj.loopList=[{value:obj.C.LOOP.FWD,name:"Forward"},{value:obj.C.LOOP.REV,name:"Backward"},{value:obj.C.LOOP.PINGPONG,name:"Pingpong"},{value:obj.C.LOOP.INNER_PINGPONG,name:"Inner Pingpong"}]}function addSequenceElementMasters(obj){function noteNum2str(table,n){return table[n%12]+(parseInt(n/12)-1).toString()}obj.noteList=_.map(_.range(128),function(e){return{value:e,name:noteNum2str(obj.ntable,e)}}).reverse(),obj.repeatList=_.map(_.range(1,9),function(e){return{value:e,name:e}}),obj.noteOffList=_.map(_.range(25),function(e){return{value:e,name:e}})}var mst={};return addConsts(mst),addPlayerMasters(mst),addSequencerMasters(mst),addSequenceElementMasters(mst),mst}function PlayerLibModel(_,jq){function SequenceElement(params){this.id=params.id,this.pos=params.pos,this.note=params.note,this.repeat=params.repeat,this.noteOff=params.noteOff,this.reTrig=params.reTrig}function Sequencer(params){function doHighlightEffect(seqElem,color,duration){var hlPanel=$("#"+seqElem+"-hl");hlPanel.css("background-color",color).show().fadeOut(duration)}var mst=params.mst;for(this.midiMgr=params.midiManager,this.name=params.name,this.muted=!1,this.currentIdx=0,this.lastNote=0,this.repPos=0,this.lastNoteOff=0,this.loopPos=0,this.totalSteps=0,this.scale=mst.scaleList[0],this.range=mst.rangeList[2],this.channel=_.find(mst.channelList,function(e){return e.value==params.channel}),this.trigger=mst.triggerList[5],this.transpose=mst.transposeList[48],this.loop=mst.loopList[0],this.numSeqElems=8,this.seqElems=[],i=0;i<this.numSeqElems;i++){var seqElem=new SequenceElement({id:this.name+"-"+(i+1),pos:i+1,note:mst.noteList[i%2==0?67:55],repeat:mst.repeatList[0],noteOff:mst.noteOffList[0],reTrig:!0});this.seqElems.push(seqElem)}this.sendChannelMsg=function(s1msb,d1,d2){var chan=this.channel.value-1;this.midiMgr.MidiOut(s1msb+chan,d1,d2)},this.Export=function(){return{name:this.name,channel:this.channel.value,trigger:this.trigger.value,transpose:this.transpose.value,mute:this.muted,loop:this.loop.value,seqElems:_.map(this.seqElems,function(e){return{id:e.id,pos:e.pos,note:e.note.value,repeat:e.repeat.value,reTrig:e.reTrig.value,noteOff:e.noteOff.value}})}},this.updateTotalSteps=function(){var ts=0;_.each(this.seqElems,function(e){ts+=e.repeat.value}),this.totalSteps=ts},this.changeMute=function(){this.Stop()},this.PreInit=function(){this.updateTotalSteps()},this.Refresh=function(){this.updateTotalSteps()},this.Randomize=function(){var scaleNoteArr=mst.scaletab[this.scale.value].notes,range=this.range.vaue;_.each(this.seqElems,function(e){var note;do note=parseInt(12*Math.random());while(1!=scaleNoteArr[note]);var octaveDiff=parseInt(Math.random()*range)-(range>3?range-3:0);note+=48+12*octaveDiff,e.note=_.find(mst.noteList,function(e){return e.value==note}),e.repeat=mst.repeatList[parseInt(4*Math.random())],e.noteOff=mst.noteOffList[parseInt(12*Math.random())],e.reTrig=!!parseInt(Math.random()+.5)}),this.Refresh(),this.sendChannelMsg(176,123,0)},this.Reset=function(){_.each(this.seqElems,function(e,i){e.note=mst.noteList[i%2==0?67:55],e.repeat=mst.repeatList[0],e.noteOff=mst.noteOffList[0],e.reTrig=!0}),this.Refresh(),this.sendChannelMsg(176,123,0)},this.Init=function(){this.loop.value==mst.C.LOOP.REV?this.currentIdx=this.numSeqElems-1:this.currentIdx=0,this.lastNote=0,this.repPos=0,this.lastNoteOff=0,this.loopPos=0},this.Stop=function(){this.sendChannelMsg(128,this.lastnote,0),this.sendChannelMsg(176,120,0),this.sendChannelMsg(176,123,0)},this.Playnote=function(){if(0==--this.lastNoteOff&&this.sendChannelMsg(128,this.lastNote,0),tcount%this.trigger.value==0){var cElem=this.seqElems[this.currentIdx],note=cElem.note.value+this.transpose.value,trg=cElem.reTrig||0===this.repPos;if(trg&&(this.muted?doHighlightEffect(cElem.id,"#cccccc",50):(this.sendChannelMsg(128,this.lastNote,0),this.sendChannelMsg(144,note,127),doHighlightEffect(cElem.id,"#ff6600",50))),this.lastNote=note,this.lastNoteOff=cElem.noteOff.value*(cElem.reTrig?1:cElem.repeat.value),this.repPos++,this.repPos>=cElem.repeat.value){this.repPos=0;var loop=this.loop.value;loop==mst.C.LOOP.FWD?(this.currentIdx++,this.currentIdx>=this.numSeqElems&&(this.currentIdx=0)):loop==mst.C.LOOP.REV?(this.currentIdx--,this.currentIdx<0&&(this.currentIdx=this.numSeqElems-1)):loop==mst.C.LOOP.PINGPONG||loop==mst.C.LOOP.INNER_PINGPONG?0==this.loopPos?(this.currentIdx++,this.currentIdx>=this.numSeqElems&&(this.currentIdx=loop==mst.C.LOOP.INNER_PINGPONG?this.numSeqElems-2:this.numSeqElems-1,this.loopPos=1)):(this.currentIdx--,this.currentIdx<0&&(this.currentIdx=loop==mst.C.LOOP.INNER_PINGPONG?1:0,this.loopPos=0)):alert("Cant be here.")}}}}function midiHandler(player,cmdArr){var a=cmdArr[0];switch(a){case 248:midiInPlaying&&player.tick();break;case 250:player.Init(),midiInPlaying=!0,console.log("Remote start.");break;case 252:player.Stop(),midiInPlaying=!1,console.log("Remote stop.");break;default:console.log("Unknown remote message"),console.log(a)}}function Player(params){var mst=params.mst,_this=this;this.midiMgr=params.midiManager,this.isPlaying=!1,this.interval=20,this.loopFuncToken=null,this.midiInList=this.midiMgr.MidiInList(),this.midiOutList=this.midiMgr.MidiOutList(),this.midiIn=this.midiInList[0],this.midiOut=this.midiOutList[0],this.tempo=mst.tempoList[80],this.sync=mst.syncList[0],this.sequencers=[new Sequencer({midiManager:params.midiManager,mst:mst,name:"seq01",channel:1}),new Sequencer({midiManager:params.midiManager,mst:mst,name:"seq02",channel:2})],this.sendSystemMsg=function(s1){this.midiMgr.MidiOut(s1)},this.Save=function(){var out={seq:_.map(this.sequencers,function(e){return e.Export()})};localStorage.setItem("midiseq-xxxx",JSON.stringify(out))},this.PreInit=function(){this.initmidi(),_.each(this.sequencers,function(e){e.PreInit()})},this.Stop=function(){_.each(this.sequencers,function(e){e.Stop()})},this.Init=function(){tcount=0,_.each(this.sequencers,function(e){e.Init()}),this.tick()},this.TogglePlay=function(){this.isPlaying?(this.Stop(),this.sync.value==mst.C.SYNC.SEND&&this.sendSystemMsg(252),this.isPlaying=!1,clearInterval(this.loopFuncToken),console.log("Stopped.")):(this.sync.value==mst.C.SYNC.SEND&&this.sendSystemMsg(250),this.isPlaying=!0,this.Init(),this.loopFuncToken=setInterval(function(){_this.tick()},this.interval),console.log("Playing."))},this.tick=function(){_this.sync.value==mst.C.SYNC.SEND&&_this.sendSystemMsg(248),_.each(_this.sequencers,function(e){e.Playnote()}),tcount++},this.initmidi=function(){var mOutVal=this.midiOut.value,mInVal=this.midiIn.value;console.log("Output Device: "+mOutVal+" Input Device: "+mInVal),this.midiMgr.MidiOutOpen(mOutVal),0!=this.mInVal&&this.midiMgr.MidiInOpen(this.mInVal,function(){var args=[].slice.call(arguments);midiHandler(_this,args)})},this.changetempo=function(){this.interval=6e4/this.tempo.value/24},this.changesync=function(){jq("#play").removeAttr("disabled"),jq("#tempo").removeAttr("disabled"),this.sync.value==mst.C.SYNC.RECV&&(jq("#play").attr("disabled","disabled"),jq("#tempo").attr("disabled","disabled"),midiHandlerId=this.midiMgr.MidiInOpen(this.midiIn.value,function(){var args=[].slice.call(arguments);midiHandler(_this,args)}))}}var tcount=0,self=function(){};return self.prototype.getPlayer=function(params){return new Player(params)},self;var midiHandlerId,midiInPlaying}angular.module("midiseq",["ngRoute","ngResource"]).config(configureMatrixApp),configureMatrixApp.$inject=["$locationProvider","$httpProvider"],angular.module("midiseq").config(routeMatrixApp),routeMatrixApp.$inject=["$routeProvider"],angular.module("midiseq").constant("API_ENDPOINT","/api/v1"),angular.module("midiseq").controller("IndexController",IndexController),IndexController.$inject=["$location","$window","$routeParams","$controller","$log","_","jq","MidiService","SeqGenClientService","PlayerLibModel","MasterData"],angular.module("midiseq").factory("MidiService",MidiService),MidiService.$inject=[],MidiManager.prototype.MidiOut=function(){var cmdArr=[].slice.call(arguments);console.log(cmdArr)},MidiManager.prototype.MidiOutOpen=function(channelNum){console.log("midioutopen")},MidiManager.prototype.MidiInOpen=function(channelNum,handler){console.log("midiinopen")},MidiManager.prototype.MidiOutList=function(){return console.log("MidiOutList"),[{value:0,name:"0: default"}]},MidiManager.prototype.MidiInList=function(){return console.log("MidiInList"),[{value:0,name:"0: default"}]},angular.module("midiseq").factory("SeqGenClientService",SeqGenClientService),SeqGenClientService.$inject=[],SocketIOClient.prototype.genSeq=function(params){this.socket.emit("genSeq",params)},angular.module("midiseq").factory("jq",function(){return $}),angular.module("midiseq").factory("_",function(){return _}),angular.module("midiseq").factory("MasterData",MasterData),MasterData.$inject=["_","jq"],angular.module("midiseq").factory("PlayerLibModel",PlayerLibModel),PlayerLibModel.$inject=["_","jq"];